import time
import json
import logging
import asyncio
import aiohttp
from aiohttp_socks import ProxyConnector
import platform
import core
import pandas as pd
import re
import os
from datetime import datetime

logger = logging.getLogger(__name__)

with open(core.GENERAL_SETTINGS, "r") as f:
    general_settings = json.load(f)

CELLTYPE_MAPPINGS = {
    "celltype": {
        0: "425",
        1: "97",
        2: "134",
        3: "129",
        4: "170",
        5: "425",
        6: "129",
        7: "129",
        8: "135",
        9: "66",
        10: "67",
        11: "129",
        12: "129",
        13: "162",
        14: "171",
        15: "425",
        16: "134",
        17: "425",
        18: "67",
        19: "162",
        20: "425",
        21: "67",
        22: "158",
        23: "2",
        24: "129",
        25: "142",
        26: "425",
        27: "66",
        28: "134",
        29: "162",
        30: "131",
        31: "169",
        32: "67",
        33: "342",
        34: "342",
        35: "98",
        36: "129",
        37: "425",
        38: "131",
        39: "131",
        40: "131",
        41: "342",
        42: "94",
        43: "162",
        44: "371",
        45: "66",
        46: "425",
        47: "162",
        48: "131",
        49: "131",
        50: "129",
        51: "131",
        52: "131",
        53: "94",
        54: "425",
        55: "425",
        56: "66",
        57: "98",
        58: "66",
        59: "67",
        60: "134",
        61: "171",
        62: "371",
        63: "425",
        64: "98",
        65: "103",
        66: "80",
        67: "87",
        68: "139",
        69: "169",
        70: "371",
        71: "425",
        72: "82",
        73: "162",
        74: "131",
        75: "131",
        76: "131",
        77: "66",
        78: "94",
        79: "94",
        80: "142",
        81: "169",
        82: "129",
        83: "139",
        84: "171",
        85: "96",
        86: "139",
        87: "158",
        88: "169",
        89: "343",
        90: "425",
        91: "129",
        92: "162",
        93: "162",
        94: "131",
        95: "66",
        96: "129",
        97: "142",
        98: "162",
        99: "132",
        100: "169",
        101: "66",
        102: "67",
        103: "162",
        104: "162",
        105: "342",
        106: "162",
        107: "162",
        108: "134",
        109: "162",
        110: "162",
        111: "162",
        112: "131",
        113: "129",
        114: "169",
        115: "342",
        116: "66",
        117: "162",
        118: "97",
        119: "169",
        120: "67",
        121: "142",
        122: "142",
        123: "425",
        124: "431",
        125: "134",
        126: "134",
        127: "131",
        128: "171",
        129: "371",
        130: "425",
        131: "425",
        132: "82",
        133: "142",
        134: "142",
        135: "162",
        136: "131",
        137: "67",
        138: "129",
        139: "425",
        140: "98",
        141: "142",
        142: "142",
        143: "162",
        144: "67",
        145: "96",
        146: "129",
        147: "132",
        148: "158",
        149: "162",
        150: "131",
        151: "342",
        152: "66",
        153: "142",
        154: "162",
        155: "131",
        156: "169",
        157: "67",
        158: "129",
        159: "142",
        160: "162",
        161: "131",
        162: "67",
        163: "131",
        164: "342",
        165: "129",
        166: "134",
        167: "139",
        168: "162",
        169: "425",
        170: "129",
        171: "142",
        172: "162",
        173: "343",
        174: "132",
        175: "142",
        176: "142",
        177: "425",
        178: "425",
        179: "142",
        180: "162",
        181: "162",
        182: "425",
        183: "66",
        184: "158",
        185: "66",
        186: "142",
        187: "131",
        188: "425",
        189: "67",
        190: "129",
        191: "129",
        192: "162",
        193: "96",
        194: "134",
        195: "371",
        196: "371",
        197: "129",
        198: "131",
        199: "425",
        200: "134",
        201: "131",
        202: "103",
        203: "162",
        204: "134",
        205: "169",
        206: "129",
        207: "162",
        208: "162",
        209: "131",
        210: "66",
        211: "158",
        212: "162",
        213: "162",
        214: "342",
        215: "371",
        216: "94",
        217: "129",
        218: "162",
        219: "342",
        220: "134",
        221: "142",
        222: "342",
        223: "371",
        224: "142",
        225: "162",
        226: "342",
        227: "431",
        228: "94",
        229: "98",
        230: "1",
        231: "139",
        232: "171",
        233: "371",
        234: "65",
        235: "129",
        236: "96",
        237: "342",
        238: "162",
        239: "425",
        240: "129",
        241: "86",
        242: "162",
        243: "169",
        244: "132",
        245: "131",
        246: "425",
        247: "129",
        248: "371",
        249: "67",
        250: "94",
        251: "129",
        252: "134",
        253: "425",
        254: "87",
        255: "162",
        256: "135",
        257: "139",
        258: "131",
        259: "371",
        260: "425",
        261: "142",
        262: "97",
        263: "425",
        264: "162",
        265: "162",
        266: "131",
        267: "131",
        268: "162",
        269: "162",
        270: "131",
        271: "131",
        272: "169",
        273: "171",
        274: "342",
        275: "129",
        276: "425",
        277: "134",
        278: "135",
        279: "67",
        280: "94",
        281: "65",
        282: "134",
        283: "371",
        284: "162",
        285: "171",
        286: "67",
        287: "134",
        288: "134",
        289: "162",
        290: "162",
        291: "129",
        292: "129",
        293: "162",
        294: "343",
        295: "162",
        296: "134",
        297: "371",
        298: "129",
        299: "139",
        300: "162",
        301: "80",
        302: "342",
        303: "425",
        304: "97",
        305: "162",
        306: "169",
        307: "134",
        308: "142",
        309: "425",
        310: "66",
        311: "342",
        312: "343",
        313: "371",
        314: "371",
        315: "425",
        316: "132",
        317: "129",
        318: "162",
        319: "162",
        320: "425",
        321: "425",
        322: "67",
        323: "86",
        324: "131",
        325: "131",
        326: "129",
        327: "129",
        328: "162",
        329: "134",
        330: "169",
        331: "134",
        332: "342",
        333: "371",
        334: "129",
        335: "86",
        336: "142",
        337: "162",
        338: "82",
        339: "371",
        340: "158",
        341: "162",
        342: "425",
        343: "67",
        344: "169",
        345: "171",
        346: "129",
        347: "139",
        348: "162",
        349: "162",
        350: "162",
        351: "169",
        352: "139",
        353: "162",
        354: "139",
        355: "158",
        356: "425",
        357: "134",
        358: "142",
        359: "162",
        360: "425",
        361: "82",
        362: "162",
        363: "162",
        364: "134",
        365: "134",
        366: "142",
        367: "162",
        368: "134",
        369: "131",
        370: "66",
        371: "162",
        372: "162",
        373: "171",
        374: "171",
        375: "431",
        376: "66",
        377: "98",
        378: "158",
        379: "131",
        380: "66",
        381: "139",
        382: "371",
        383: "87",
        384: "87",
        385: "134",
        386: "131",
        387: "342",
        388: "32",
        389: "131",
        390: "131",
        391: "169",
        392: "103",
        393: "134",
        394: "131",
        395: "371",
        396: "94",
        397: "162",
        398: "162",
        399: "66",
        400: "162",
        401: "129",
        402: "134",
        403: "162",
        404: "142",
        405: "162",
        406: "142",
        407: "371",
        408: "425",
        409: "431",
        410: "96",
        411: "80",
        412: "142",
        413: "342",
        414: "67",
        415: "142",
        416: "129",
        417: "129",
        418: "142",
        419: "142",
        420: "162",
        421: "342",
        422: "65",
        423: "129",
        424: "169",
        425: "169",
        426: "134",
        427: "142",
        428: "425",
        429: "425",
        430: "425",
        431: "126",
        432: "134",
        433: "425",
        434: "162",
        435: "162",
        436: "171",
        437: "343",
        438: "162",
        439: "66",
        440: "142",
        441: "162",
        442: "131",
        443: "371",
        444: "103",
        445: "162",
        446: "162",
        447: "139",
        448: "131",
        449: "96",
        450: "97",
        451: "139",
        452: "371",
        453: "67",
        454: "82",
        455: "91",
        456: "131",
        457: "425",
        458: "96",
        459: "87",
        460: "134",
        461: "142",
        462: "162",
        463: "96",
        464: "139",
        465: "162",
        466: "131",
        467: "342",
        468: "129",
        469: "135",
        470: "162",
        471: "67",
        472: "129",
        473: "135",
        474: "131",
        475: "134",
        476: "162",
        477: "425",
        478: "169",
        479: "67",
        480: "129",
        481: "131",
        482: "371",
        483: "129",
        484: "134",
        485: "67",
        486: "162",
        487: "371",
        488: "131",
        489: "371",
        490: "129",
        491: "162",
        492: "371",
        493: "33",
        494: "129",
        495: "162",
        496: "66",
        497: "67",
        498: "134",
        499: "142",
        500: "162",
        501: "131",
        502: "131",
        503: "425",
        504: "129",
        505: "162",
        506: "131",
        507: "36",
        508: "65",
        509: "131",
        510: "371",
        511: "94",
        512: "65",
        513: "134",
        514: "135",
        515: "162",
        516: "132",
        517: "134",
        518: "134",
        519: "162",
        520: "342",
        521: "142",
        522: "371",
        523: "66",
        524: "342",
        525: "162",
        526: "131",
        527: "91",
        528: "169",
        529: "371",
        530: "425",
        531: "425",
        532: "425",
        533: "425",
        534: "98",
        535: "129",
        536: "134",
        537: "142",
        538: "425",
        539: "67",
        540: "132",
        541: "134",
        542: "131",
        543: "371",
        544: "431",
        545: "162",
        546: "342",
    },
    "property_name": {
        0: "OA DAMPER %",
        1: "PRESSURE IN",
        2: "OCC STATE",
        3: "DROPLEG PRES",
        4: "E2 DEWPT",
        5: "COMP 1 STAT %",
        6: "FAN OUT8",
        7: "DISCHARGE OUT",
        8: "ZONE HUM OUT",
        9: "DIG INPUT15",
        10: "DI6",
        11: "FAN PROOF IN11",
        12: "FST REC VAL OUT",
        13: "STAGE STATUS4",
        14: "POWER FACTOR",
        15: "COND FAN 6",
        16: "SPACE HUMID",
        17: "REHEAT1 ACTIVE",
        18: "DO2",
        19: "STAGE STATUS1",
        20: "UNOCC DEWPT SP",
        21: "DI8",
        22: "VALVE % 6",
        23: "OUTPUT",
        24: "FAN PROOF IN8",
        25: "FAN RUN PCT",
        26: "COMP 2 STAT",
        27: "DIG INPUT7",
        28: "FAN FAILED",
        29: "STAGE STATUS5",
        30: "PRODUCT TEMP 5",
        31: "ACTIVE SP",
        32: "DI4",
        33: "CONCENTRATION2",
        34: "CONCENTRATION14",
        35: "ALL LIGHTS ON",
        36: "Number of Fans",
        37: "RECLAIM1 ACTIVE",
        38: "PRODUCT TEMP 6",
        39: "DEFROST",
        40: "CASE ALM LO SP",
        41: "CONCENTRATION5",
        42: "CUTOUT",
        43: "FLT TARGET TEMP",
        44: "COMP C SUC PSI",
        45: "Num Inputs",
        46: "SPACE TEMP",
        47: "RACK FAIL",
        48: "CASE TEMP 12",
        49: "PRODUCT TEMP 8",
        50: "CONTROL METHOD",
        51: "CASE TEMP 2",
        52: "CASE ALM OUT 5",
        53: "CUTIN",
        54: "SUPPLY AIR TEMP",
        55: "COND FAN 5",
        56: "DIG INPUT12",
        57: "DAY SCHED IN",
        58: "INVERT OUTPUT",
        59: "AI2",
        60: "SPACE TEMP 1",
        61: "CAPCITY REQ IN",
        62: "COMP B SUC PSI",
        63: "UNOCC HEAT SP",
        64: "IN BYPASS",
        65: "DIG INPUT 1",
        66: "OUTPUT",
        67: "DAILY TOTAL",
        68: "DISCHARGE AIR1",
        69: "VALVE PCT",
        70: "OAT",
        71: "HEAT STAGE 2",
        72: "COMP RUN IN",
        73: "STAGE STATUS9",
        74: "PRODUCT TEMP 10",
        75: "EEPR VALVE",
        76: "CASE TEMP 8",
        77: "OUTPUT",
        78: "INPUT2",
        79: "INPUT3",
        80: "COOL4",
        81: "TERM TEMP",
        82: "FAN OUT6",
        83: "TERM TEMP",
        84: "DSCH TEMP OUT",
        85: "LOGIC IN3",
        86: "DISCHARGE AIR2",
        87: "VALVE % 8",
        88: "CASE TEMP SP",
        89: "COMP RUNNING",
        90: "RECLAIM2 ACTIVE",
        91: "FAN OUT7",
        92: "STAGE OUT1",
        93: "TOTAL STAGES",
        94: "CASE ALM OUT 6",
        95: "DIG INPUT14",
        96: "FAN PROOF IN2",
        97: "Num Heat Stages",
        98: "COMP DIG OIL9",
        99: "TEMPERATURE",
        100: "DISCH 3",
        101: "DIG INPUT16",
        102: "DI7",
        103: "COMP DIG OIL13",
        104: "SUCT TEMP SETPT",
        105: "ZER PKPK",
        106: "STAGE OUT2",
        107: "STAGE STATUS6",
        108: "FAN PROOF IN",
        109: "SUCTION STEPUP",
        110: "COMP PROOF2",
        111: "STAGE OUT13",
        112: "ALARM OUT",
        113: "FAN PROOF IN1",
        114: "AntiSwt HI Stpt",
        115: "AMBIENT PRES",
        116: "DIG INPUT10",
        117: "SAT SUCT TEMP",
        118: "Conversion Type",
        119: "CASE TEMP",
        120: "AI4",
        121: "COOL RUN PCT1",
        122: "HEAT RUN PCT4",
        123: "HEAT STAGE 4",
        124: "MOTOR_FLA",
        125: "OCCUPANCY",
        126: "VS FAN OUTPUT",
        127: "CASE TEMP 7",
        128: "COMP RUN OUT",
        129: "COMD D SUC PSI",
        130: "SPLY FAN STAT %",
        131: "MIXED AIR TEMP",
        132: "POWER FACTOR",
        133: "COOL3",
        134: "SUPPLY TEMP",
        135: "COMP PROOF13",
        136: "Defrost Time 1",
        137: "AO2",
        138: "FAN OUT10",
        139: "OUTDR HUMIDITY",
        140: "BYPASS ON",
        141: "SPACE TEMP",
        142: "COOL RUN PCT4",
        143: "STAGE OUT9",
        144: "DI2",
        145: "LOGIC IN1",
        146: "MIN TEMP STPT",
        147: "OUTPUT",
        148: "VALVE % 7",
        149: "Refrigerant",
        150: "CASE TEMP STPT",
        151: "CONCENTRATION15",
        152: "DIG INPUT3",
        153: "ECONOMIZE",
        154: "COMP PROOF7",
        155: "CASE TEMP 5",
        156: "ANTISWEAT PCT",
        157: "DO4",
        158: "SHUT DOWN",
        159: "CONTROL TEMP",
        160: "FLOAT ENABLE",
        161: "CASE ALM OUT 3",
        162: "AO1",
        163: "PRODUCT TEMP 12",
        164: "VACUUM PRES",
        165: "FAN OUT5",
        166: "WINTER COOL OCC",
        167: "DISCHARGE AIR4",
        168: "PHASE LOSS",
        169: "HEAT MODE",
        170: "LIQUID LEVEL",
        171: "HEAT RUN PCT1",
        172: "STAGE STATUS13",
        173: "TOTAL STARTS",
        174: "DEWPOINT OUT",
        175: "HEAT4",
        176: "OUTDOOR TEMP",
        177: "DEHUM MODE",
        178: "CO2 LEVEL",
        179: "OA DAMPER POS",
        180: "COMP DIG OIL11",
        181: "CUR TEMP SETPT",
        182: "COMP CAPACITY%",
        183: "DIG INPUT11",
        184: "VALVE % 4",
        185: "DIG INPUT1",
        186: "Num Cool Stages",
        187: "DUAL TEMP STPT",
        188: "HEAT STAGE 3",
        189: "AO3",
        190: "FAN OUT11",
        191: "VS RPM",
        192: "STAGE STATUS7",
        193: "COMMAND OUT",
        194: "Fan Type",
        195: "AUX HT STG 2",
        196: "COMP C DS PSI",
        197: "DISCH TRIP IN",
        198: "PRODUCT TEMP 4",
        199: "SUC PSI SP GP 1",
        200: "WINTER HEAT UOC",
        201: "CASE TEMP 10",
        202: "RELAY OUT 1",
        203: "COMP DIG OIL10",
        204: "Control Type",
        205: "Disch 4 Offs",
        206: "FAN OUT9",
        207: "COMP PROOF12",
        208: "SUBCOOLER",
        209: "Defrost Time 3",
        210: "DIG INPUT8",
        211: "VALVE % 1",
        212: "COMP DIG OIL1",
        213: "STAGE OUT10",
        214: "AVERAGE PKPK",
        215: "SUPPLY DEWPOINT",
        216: "BYPASS VALUE",
        217: "FAN PROOF IN3",
        218: "STAGE OUT5",
        219: "CONCENTRATION6",
        220: "Dehumidify By",
        221: "COOL2",
        222: "CONCENTRATION3",
        223: "SUPPLY FN FAULT",
        224: "HEAT RUN PCT3",
        225: "CUR PRES SETPT",
        226: "CONCENTRATION12",
        227: "MOTOR_PWR_FACTR",
        228: "INPUT1",
        229: "LIGHTS OUTPUT",
        230: "OUTPUT",
        231: "DOOR STATE",
        232: "SAT SUCT TEMP",
        233: "SUPPLY TEMP",
        234: "OUTPUT",
        235: "REFRIG TEMP OUT",
        236: "NUM INPUTS ON",
        237: "CONCENTRATION4",
        238: "COMP DIG OIL4",
        239: "INDR HUMIDITY",
        240: "AMB SPLIT STPT",
        241: "PRESENT KW",
        242: "COMP PROOF3",
        243: "Ref Leak Detect",
        244: "REL HUMIDITY",
        245: "CASE TEMP 3",
        246: "RA DAMPER %",
        247: "AMB TEMP IN",
        248: "AUX HT STG 3",
        249: "AI3",
        250: "INPUT SELECT",
        251: "FAN PROOF IN9",
        252: "VS INVTR FAIL",
        253: "RETURN AIR TEMP",
        254: "DAILY PEAK",
        255: "DISCHARGE PRES",
        256: "ACTIVE CL STPT",
        257: "LIGHT STATE",
        258: "FAN",
        259: "COMP B",
        260: "OCC DEPT SP",
        261: "UNOCC COOL",
        262: "TEMP OUT",
        263: "COND FAN 4",
        264: "COMP DIG OIL6",
        265: "STAGE OUT14",
        266: "Defrost Time 6",
        267: "CASE TEMP 6",
        268: "COMP PROOF14",
        269: "STAGE STATUS15",
        270: "Defrost Time 5",
        271: "PRODUCT TEMP 2",
        272: "Disch 2 Offs",
        273: "SAT TEMP OUT",
        274: "CONCENTRATION7",
        275: "SPLIT VALVE",
        276: "COMP 3 STAT",
        277: "APPARENT TMP EN",
        278: "ZONE TEMP OUT",
        279: "AO4",
        280: "INPUT4",
        281: "ANALOG INPUT1",
        282: "SUM WNTR MODE",
        283: "SUPPLY FN %",
        284: "COMP PROOF10",
        285: "COMP RUN PROOF",
        286: "AI1",
        287: "WINTER HEAT OCC",
        288: "SUM WNTR IN",
        289: "COMP PROOF9",
        290: "STAGE OUT12",
        291: "FAN OUT2",
        292: "FAN PROOF IN7",
        293: "FILTERED PRES",
        294: "DISCH LINE TEMP",
        295: "COMP PROOF1",
        296: "SS FAN OUT",
        297: "HEAT STG 2 SPT",
        298: "FAN PROOF IN5",
        299: "CASE MODE",
        300: "SUCTION TEMP",
        301: "SCHED OUTPUT",
        302: "CONCENTRATION8",
        303: "LOAD SHED",
        304: "Refrig Type",
        305: "CUR SUPERHEAT",
        306: "ANTISWEAT PCT",
        307: "SUMMER HEAT UOC",
        308: "HEAT1",
        309: "SPACE DEWPOINT",
        310: "DIG INPUT13",
        311: "PKPK",
        312: "PROOF OUT",
        313: "COMD D DS PSI",
        314: "INDOOR DEWPOINT",
        315: "CLOGGED FILTER",
        316: "FULL OFF DEWPT",
        317: "FST REC SP OUT",
        318: "SUCTION PRES",
        319: "STAGE OUT4",
        320: "# of Compressor",
        321: "COND FAN 3",
        322: "DI3",
        323: "DAILY KWH",
        324: "ACTIVE SETPT",
        325: "REFRIG SOLENOID",
        326: "FAN OUT1",
        327: "REFG TYPE OUT",
        328: "COMP DIG OIL16",
        329: "SUPPLY TEMP",
        330: "REFG LEAK",
        331: "HEAT STAGE3",
        332: "CONCENTRATION9",
        333: "COMP A SUC PSI",
        334: "DROPLEG TEMP",
        335: "HOURLY KWH",
        336: "COOL1",
        337: "STAGE STATUS11",
        338: "COMP RUN PROOF",
        339: "HEAT STG 1 SPT",
        340: "VALVE % 3",
        341: "STAGE OUT7",
        342: "COMP 4 STAT",
        343: "AI5",
        344: "Refr Leak Offs",
        345: "COMP STARTS",
        346: "PRES CTRL IN",
        347: "ACTIVE CASE SP",
        348: "FLOAT TEMP",
        349: "EMERGENCY OVR",
        350: "STAGE STATUS8",
        351: "DISCH 2",
        352: "CASE TEMP SP",
        353: "COMP DIG OIL3",
        354: "DEW POINT",
        355: "VALVE % 5",
        356: "COOL MODE",
        357: "HEAT STAGE4",
        358: "SEASON",
        359: "COMP PROOF16",
        360: "REHEAT2 ACTIVE",
        361: "POWER CONSUMPT",
        362: "COMP DIG OIL7",
        363: "COMP PROOF6",
        364: "SUMMER HEAT OCC",
        365: "HEAT STAGE2",
        366: "ZONE TEMP",
        367: "COMP PROOF4",
        368: "HEAT STAGE1",
        369: "PRODUCT TEMP 7",
        370: "DIG INPUT9",
        371: "COMP DIG OIL5",
        372: "STAGE STATUS14",
        373: "POWER CONSUMPT",
        374: "SUCTION PRES IN",
        375: "OUT_FREQ_",
        376: "DIG INPUT5",
        377: "ACTIVE SCHED",
        378: "VALVE % 2",
        379: "CASE ALM OUT 2",
        380: "DIG INPUT4",
        381: "VALVE POS",
        382: "COMP A DS PSI",
        383: "HOURLY PEAK",
        384: "HOURLY TOTAL",
        385: "OUTDOOR HUMID",
        386: "CASE TEMP 11",
        387: "CONCENTRATION13",
        388: "INPUT",
        389: "CASE TEMP 1",
        390: "TERM TEMP SP",
        391: "DISCH 1",
        392: "RELAY OUT 2",
        393: "WINTER COOL UOC",
        394: "PRODUCT TEMP 11",
        395: "COMP B DS PSI",
        396: "CONTROL VALUE",
        397: "STAGE STATUS12",
        398: "STAGE OUT16",
        399: "NUM INPUTS ON",
        400: "GROUP LLSV",
        401: "FAN PROOF IN12",
        402: "SUMMER COOL OCC",
        403: "STAGE OUT15",
        404: "COOL RUN PCT2",
        405: "SUCT PRES SETPT",
        406: "OCC HEAT",
        407: "COMP FAULT",
        408: "SUPPLY HEAT SP",
        409: "CURRENT_TORQUE",
        410: "BYPASS VALUE",
        411: "DAY SCHED OUT",
        412: "FAN",
        413: "CONCENTRATION11",
        414: "DI1",
        415: "RETURN TEMP",
        416: "PRES CTRL STPT",
        417: "FAN PROOF IN4",
        418: "ZONE OCC",
        419: "HEAT2",
        420: "COMP DIG OIL15",
        421: "CONCENTRATION1",
        422: "ANALOG INPUT3",
        423: "FAN OUT3",
        424: "Disch 3 Offs",
        425: "DISCH 4",
        426: "Controlled By",
        427: "COOL RUN PCT3",
        428: "UNOCC COOL SP",
        429: "OCC COOL SP",
        430: "SUC PSI SP GP 2",
        431: "STATUS",
        432: "COOL STAGE1",
        433: "COND FAN 1",
        434: "COMP DIG OIL2",
        435: "STAGES ACTIVE",
        436: "COMP CURRENT",
        437: "ACT RUN OUT",
        438: "COMP PROOF11",
        439: "Comb Method",
        440: "OCC COOL",
        441: "STAGE STATUS16",
        442: "PRODUCT TEMP 1",
        443: "AUX HT STG 1",
        444: "DIG INPUT 2",
        445: "COMP PROOF8",
        446: "STAGE STATUS3",
        447: "DEFR TERM TEMP1",
        448: "Defrost Time 2",
        449: "CONTROL VALUE",
        450: "Use Abs Pressure",
        451: "DISCHARGE AIR3",
        452: "HEAT STG 4 SPT",
        453: "AI8",
        454: "SUCTION PRES IN",
        455: "OUTDOOR HUMID",
        456: "CASE ALM OUT 1",
        457: "OCC HEAT SP",
        458: "LOGIC IN2",
        459: "TOTAL",
        460: "PHASE LOSS",
        461: "HEAT RUN PCT2",
        462: "COMP DIG OIL8",
        463: "LOGIC IN4",
        464: "CASE TEMP",
        465: "STAGE STATUS10",
        466: "CIRCUIT STATE",
        467: "CONCENTRATION10",
        468: "FAN OUT12",
        469: "SUM WNTR MODE",
        470: "COMP PROOF15",
        471: "AI7",
        472: "VS FAN OUT",
        473: "OCCUPANCY",
        474: "PRODUCT TEMP 9",
        475: "SUMMER COOL UOC",
        476: "STAGE OUT6",
        477: "BA DAMPER %",
        478: "AntiSwt LO Stpt",
        479: "AI6",
        480: "FAN OUT4",
        481: "CASE ALM OUT 4",
        482: "HEAT STG 3 SPT",
        483: "VS FREQ",
        484: "COOL STAGE2",
        485: "DI5",
        486: "FLOAT CKT STATE",
        487: "COMP C",
        488: "PRODUCT TEMP 3",
        489: "ZONE DH SETPT",
        490: "UNSPLIT STPT",
        491: "SUCT MON TEMP",
        492: "ZONE HEAT SETPT",
        493: "INPUT",
        494: "TEMP DIF STPT",
        495: "STAGE OUT8",
        496: "DIG INPUT6",
        497: "DO1",
        498: "ACT DEHUM SETPT",
        499: "HEAT3",
        500: "COMP PROOF5",
        501: "CASE TEMP 9",
        502: "CASE TEMP 4",
        503: "COMP 2 STAT %",
        504: "FAN PROOF IN6",
        505: "STAGE OUT3",
        506: "CONTROL TEMP",
        507: "INPUT",
        508: "Num Inputs",
        509: "Defrost Time 4",
        510: "COMP A",
        511: "COMMAND OUT",
        512: "ANALOG INPUT2",
        513: "HEAT COOL MODE",
        514: "ACTIVE HT STPT",
        515: "STAGE STATUS2",
        516: "DEWPOINT IN",
        517: "RETURN TEMP",
        518: "ACTIVE SETPT",
        519: "COMP DIG OIL12",
        520: "TEMPERATURE",
        521: "UNOCC HEAT",
        522: "AUX HT STG 4",
        523: "DIG INPUT2",
        524: "PRESSURE",
        525: "STAGE OUT11",
        526: "CASE ALM HI SP",
        527: "OUTDOOR TEMP",
        528: "Disch 1 Offs",
        529: "COMP D",
        530: "COND FAN 2",
        531: "HEAT CAPACITY%",
        532: "HEAT STAGE 1",
        533: "OUTDR AIR TEMP",
        534: "LIGHT LEVEL IN",
        535: "FAN PROOF IN10",
        536: "APPARENT TEMP",
        537: "OCCUPANCY",
        538: "OUTDR AIR DEWPT",
        539: "DO3",
        540: "FULL ON DEWPT",
        541: "OUTDOOR TEMP",
        542: "PEAK DEF TEMP",
        543: "ZONE COOL SETPT",
        544: "ENERGY_KW/H",
        545: "COMP DIG OIL14",
        546: "CONCENTRATION16",
    },
    "property_index": {
        0: "2098.0",
        1: "3.0",
        2: "2069.0",
        3: "78.0",
        4: "2073.0",
        5: "2087.0",
        6: "2059.0",
        7: "2101.0",
        8: "2049.0",
        9: "17.0",
        10: "14.0",
        11: "19.0",
        12: "2098.0",
        13: "2141.0",
        14: "2129.0",
        15: "2109.0",
        16: "7.0",
        17: "2102.0",
        18: "2054.0",
        19: "2138.0",
        20: "7138.0",
        21: "16.0",
        22: "6.0",
        23: "2048.0",
        24: "16.0",
        25: "2075.0",
        26: "2089.0",
        27: "9.0",
        28: "2073.0",
        29: "2142.0",
        30: "33.0",
        31: "2052.0",
        32: "12.0",
        33: "2049.0",
        34: "2061.0",
        35: "15.0",
        36: "7001.0",
        37: "2100.0",
        38: "34.0",
        39: "2054.0",
        40: "2071.0",
        41: "2052.0",
        42: "16.0",
        43: "92.0",
        44: "2059.0",
        45: "7004.0",
        46: "2051.0",
        47: "2089.0",
        48: "41.0",
        49: "43.0",
        50: "2102.0",
        51: "4.0",
        52: "2067.0",
        53: "14.0",
        54: "2056.0",
        55: "2108.0",
        56: "14.0",
        57: "22.0",
        58: "20.0",
        59: "2.0",
        60: "6.0",
        61: "7.0",
        62: "2058.0",
        63: "7136.0",
        64: "2053.0",
        65: "2048.0",
        66: "2048.0",
        67: "2056.0",
        68: "2067.0",
        69: "2054.0",
        70: "2048.0",
        71: "2093.0",
        72: "1.0",
        73: "2146.0",
        74: "45.0",
        75: "2051.0",
        76: "37.0",
        77: "2048.0",
        78: "19.0",
        79: "20.0",
        80: "2057.0",
        81: "2053.0",
        82: "2057.0",
        83: "2065.0",
        84: "2050.0",
        85: "15.0",
        86: "2068.0",
        87: "8.0",
        88: "8.0",
        89: "2054.0",
        90: "2101.0",
        91: "2058.0",
        92: "2048.0",
        93: "2129.0",
        94: "2068.0",
        95: "16.0",
        96: "10.0",
        97: "7099.0",
        98: "17.0",
        99: "4.0",
        100: "2062.0",
        101: "18.0",
        102: "15.0",
        103: "21.0",
        104: "8.0",
        105: "2067.0",
        106: "2049.0",
        107: "2143.0",
        108: "15.0",
        109: "3.0",
        110: "42.0",
        111: "2060.0",
        112: "2058.0",
        113: "9.0",
        114: "7010.0",
        115: "2070.0",
        116: "12.0",
        117: "2090.0",
        118: "7000.0",
        119: "2051.0",
        120: "4.0",
        121: "2076.0",
        122: "2083.0",
        123: "2095.0",
        124: "7128.0",
        125: "2.0",
        126: "2077.0",
        127: "36.0",
        128: "2048.0",
        129: "2060.0",
        130: "2084.0",
        131: "2061.0",
        132: "2091.0",
        133: "2056.0",
        134: "2068.0",
        135: "53.0",
        136: "7026.0",
        137: "2050.0",
        138: "2061.0",
        139: "2126.0",
        140: "13.0",
        141: "2067.0",
        142: "2079.0",
        143: "2056.0",
        144: "10.0",
        145: "13.0",
        146: "65.0",
        147: "2048.0",
        148: "7.0",
        149: "7002.0",
        150: "9.0",
        151: "2062.0",
        152: "5.0",
        153: "12.0",
        154: "47.0",
        155: "7.0",
        156: "2057.0",
        157: "2056.0",
        158: "8.0",
        159: "2074.0",
        160: "64.0",
        161: "2065.0",
        162: "2049.0",
        163: "47.0",
        164: "2069.0",
        165: "2056.0",
        166: "24.0",
        167: "2070.0",
        168: "59.0",
        169: "2050.0",
        170: "74.0",
        171: "2080.0",
        172: "2150.0",
        173: "2094.0",
        174: "2049.0",
        175: "2053.0",
        176: "4.0",
        177: "2048.0",
        178: "2062.0",
        179: "24.0",
        180: "19.0",
        181: "2095.0",
        182: "2085.0",
        183: "13.0",
        184: "4.0",
        185: "3.0",
        186: "7100.0",
        187: "10.0",
        188: "2094.0",
        189: "2051.0",
        190: "2062.0",
        191: "2076.0",
        192: "2144.0",
        193: "2048.0",
        194: "7047.0",
        195: "2075.0",
        196: "2055.0",
        197: "4.0",
        198: "32.0",
        199: "2110.0",
        200: "23.0",
        201: "39.0",
        202: "1.0",
        203: "18.0",
        204: "7000.0",
        205: "7087.0",
        206: "2060.0",
        207: "52.0",
        208: "2067.0",
        209: "7028.0",
        210: "10.0",
        211: "1.0",
        212: "9.0",
        213: "2057.0",
        214: "2066.0",
        215: "2080.0",
        216: "5.0",
        217: "11.0",
        218: "2052.0",
        219: "2053.0",
        220: "7013.0",
        221: "2055.0",
        222: "2050.0",
        223: "2063.0",
        224: "2082.0",
        225: "2094.0",
        226: "2059.0",
        227: "7132.0",
        228: "18.0",
        229: "2048.0",
        230: "2048.0",
        231: "2054.0",
        232: "10.0",
        233: "2050.0",
        234: "2048.0",
        235: "2100.0",
        236: "2060.0",
        237: "2051.0",
        238: "12.0",
        239: "2125.0",
        240: "40.0",
        241: "2049.0",
        242: "43.0",
        243: "7045.0",
        244: "5.0",
        245: "5.0",
        246: "2096.0",
        247: "5.0",
        248: "2076.0",
        249: "3.0",
        250: "22.0",
        251: "17.0",
        252: "2074.0",
        253: "2053.0",
        254: "2059.0",
        255: "7.0",
        256: "2062.0",
        257: "2049.0",
        258: "2056.0",
        259: "2071.0",
        260: "7137.0",
        261: "9.0",
        262: "2051.0",
        263: "2107.0",
        264: "14.0",
        265: "2061.0",
        266: "7031.0",
        267: "8.0",
        268: "54.0",
        269: "2152.0",
        270: "7030.0",
        271: "30.0",
        272: "7083.0",
        273: "2051.0",
        274: "2054.0",
        275: "2077.0",
        276: "2090.0",
        277: "3.0",
        278: "2048.0",
        279: "2052.0",
        280: "21.0",
        281: "4.0",
        282: "2083.0",
        283: "2062.0",
        284: "50.0",
        285: "2049.0",
        286: "1.0",
        287: "22.0",
        288: "54.0",
        289: "49.0",
        290: "2059.0",
        291: "2053.0",
        292: "15.0",
        293: "2136.0",
        294: "2052.0",
        295: "41.0",
        296: "2082.0",
        297: "7.0",
        298: "13.0",
        299: "2052.0",
        300: "2.0",
        301: "2049.0",
        302: "2055.0",
        303: "2066.0",
        304: "7001.0",
        305: "2135.0",
        306: "2065.0",
        307: "19.0",
        308: "2050.0",
        309: "2127.0",
        310: "15.0",
        311: "2065.0",
        312: "2050.0",
        313: "2056.0",
        314: "2052.0",
        315: "2065.0",
        316: "7.0",
        317: "2099.0",
        318: "1.0",
        319: "2051.0",
        320: "2121.0",
        321: "2106.0",
        322: "11.0",
        323: "2054.0",
        324: "2049.0",
        325: "2050.0",
        326: "2052.0",
        327: "2095.0",
        328: "24.0",
        329: "8.0",
        330: "2067.0",
        331: "2052.0",
        332: "2056.0",
        333: "2057.0",
        334: "77.0",
        335: "2053.0",
        336: "2054.0",
        337: "2148.0",
        338: "2049.0",
        339: "6.0",
        340: "3.0",
        341: "2054.0",
        342: "2091.0",
        343: "5.0",
        344: "7091.0",
        345: "2060.0",
        346: "2.0",
        347: "2061.0",
        348: "5.0",
        349: "68.0",
        350: "2145.0",
        351: "2058.0",
        352: "12.0",
        353: "11.0",
        354: "7.0",
        355: "5.0",
        356: "2049.0",
        357: "2053.0",
        358: "11.0",
        359: "56.0",
        360: "2103.0",
        361: "2092.0",
        362: "15.0",
        363: "46.0",
        364: "18.0",
        365: "2051.0",
        366: "14.0",
        367: "44.0",
        368: "2050.0",
        369: "42.0",
        370: "11.0",
        371: "13.0",
        372: "2151.0",
        373: "2130.0",
        374: "11.0",
        375: "2072.0",
        376: "7.0",
        377: "2054.0",
        378: "2.0",
        379: "2064.0",
        380: "6.0",
        381: "2064.0",
        382: "2053.0",
        383: "2058.0",
        384: "2055.0",
        385: "11.0",
        386: "40.0",
        387: "2060.0",
        388: "1.0",
        389: "3.0",
        390: "24.0",
        391: "2056.0",
        392: "2.0",
        393: "25.0",
        394: "46.0",
        395: "2054.0",
        396: "2049.0",
        397: "2149.0",
        398: "2063.0",
        399: "2051.0",
        400: "2131.0",
        401: "20.0",
        402: "20.0",
        403: "2062.0",
        404: "2077.0",
        405: "6.0",
        406: "6.0",
        407: "2064.0",
        408: "2119.0",
        409: "2074.0",
        410: "4.0",
        411: "2050.0",
        412: "2049.0",
        413: "2058.0",
        414: "9.0",
        415: "2069.0",
        416: "3.0",
        417: "12.0",
        418: "10.0",
        419: "2051.0",
        420: "23.0",
        421: "2048.0",
        422: "6.0",
        423: "2054.0",
        424: "7085.0",
        425: "2064.0",
        426: "7001.0",
        427: "2078.0",
        428: "7134.0",
        429: "7133.0",
        430: "2111.0",
        431: "2048.0",
        432: "2058.0",
        433: "2104.0",
        434: "10.0",
        435: "2128.0",
        436: "2127.0",
        437: "2095.0",
        438: "51.0",
        439: "7002.0",
        440: "8.0",
        441: "2153.0",
        442: "29.0",
        443: "2074.0",
        444: "2049.0",
        445: "48.0",
        446: "2140.0",
        447: "2074.0",
        448: "7027.0",
        449: "2053.0",
        450: "7003.0",
        451: "2069.0",
        452: "9.0",
        453: "8.0",
        454: "2.0",
        455: "2.0",
        456: "2063.0",
        457: "7135.0",
        458: "14.0",
        459: "2053.0",
        460: "48.0",
        461: "2081.0",
        462: "16.0",
        463: "16.0",
        464: "2063.0",
        465: "2147.0",
        466: "2048.0",
        467: "2057.0",
        468: "2063.0",
        469: "2057.0",
        470: "55.0",
        471: "7.0",
        472: "2051.0",
        473: "2.0",
        474: "44.0",
        475: "21.0",
        476: "2053.0",
        477: "2097.0",
        478: "7009.0",
        479: "6.0",
        480: "2055.0",
        481: "2066.0",
        482: "8.0",
        483: "73.0",
        484: "2059.0",
        485: "13.0",
        486: "63.0",
        487: "2072.0",
        488: "31.0",
        489: "2.0",
        490: "42.0",
        491: "86.0",
        492: "10.0",
        493: "1.0",
        494: "6.0",
        495: "2055.0",
        496: "8.0",
        497: "2053.0",
        498: "2068.0",
        499: "2052.0",
        500: "45.0",
        501: "38.0",
        502: "6.0",
        503: "2088.0",
        504: "14.0",
        505: "2050.0",
        506: "2052.0",
        507: "1.0",
        508: "2050.0",
        509: "7029.0",
        510: "2070.0",
        511: "2048.0",
        512: "5.0",
        513: "2066.0",
        514: "2061.0",
        515: "2139.0",
        516: "3.0",
        517: "12.0",
        518: "2067.0",
        519: "20.0",
        520: "2064.0",
        521: "7.0",
        522: "2077.0",
        523: "4.0",
        524: "2068.0",
        525: "2058.0",
        526: "2070.0",
        527: "1.0",
        528: "7081.0",
        529: "2073.0",
        530: "2105.0",
        531: "2086.0",
        532: "2092.0",
        533: "2054.0",
        534: "1.0",
        535: "18.0",
        536: "2070.0",
        537: "2072.0",
        538: "2128.0",
        539: "2055.0",
        540: "6.0",
        541: "10.0",
        542: "2055.0",
        543: "4.0",
        544: "2063.0",
        545: "22.0",
        546: "2063.0",
    },
}
CELLTYPE_MAPPINGS_TABLE = pd.DataFrame(CELLTYPE_MAPPINGS)


class E2HttpInterface:
    def __init__(self, ip: str):
        self.ip = ip
        self.endpoint = f"http://{ip}:14106/JSON-RPC"

        self.timeout_seconds = general_settings.get("http_timeout_delay", 3)
        self.retries = general_settings.get("http_retry_count", 3)
        self.failed_requests = 0
        self.http_request_delay = general_settings.get("http_request_delay", 3)

        self.http_headers = {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest",
        }

        self._session: aiohttp.ClientSession | None = None

        self.timeout = aiohttp.ClientTimeout(
            connect=self.timeout_seconds,
            sock_connect=self.timeout_seconds,
            sock_read=self.timeout_seconds,
            total=self.timeout_seconds * 2,
        )

    async def _ensure_session(self):
        if self._session and not self._session.closed:
            await self.close()

        connector = None
        if platform.system() == "Linux":
            connector = ProxyConnector.from_url("socks5://localhost:1080")

        self._session = aiohttp.ClientSession(
            connector=connector,
            timeout=self.timeout,
            headers=self.http_headers,
        )

    async def close(self):
        if self._session and not self._session.closed:
            await self._session.close()

    async def _post_jsonrpc(self, payload: dict) -> dict:
        await self._ensure_session()

        for attempt in range(1, self.retries + 1):
            try:
                logger.debug("E2 RPC attempt %d â†’ %s", attempt, payload)

                async with self._session.post(self.endpoint, json=payload) as resp:
                    if resp.status != 200:
                        logger.warning(
                            "E2 RPC HTTP %s on attempt %d",
                            resp.status,
                            attempt,
                        )
                        continue

                    try:
                        res = await resp.text()
                        try:
                            ret = json.loads(res)
                        except:
                            fixed = re.sub(r'(?<=[A-Za-z0-9])"(?=[A-Za-z0-9])', "", res)
                            ret = json.loads(fixed)
                        self.failed_requests = 0
                        await self.close()
                        await asyncio.sleep(self.http_request_delay)
                        return ret
                    except Exception as e:
                        logger.error(e)
                        return {}

            except asyncio.TimeoutError:
                logger.warning("E2 RPC timeout on attempt %d", attempt)
                await asyncio.sleep(self.http_request_delay)

            except aiohttp.ClientError as e:
                logger.error("E2 RPC client error on attempt %d: %s", attempt, e)
                await self.close()
                with open("lock.json", "w+") as f:
                    lock = {"timestamp": datetime.now().isoformat()}
                    json.dump(lock, f)
                time.sleep(1)
                os._exit(1)

            except Exception:
                logger.exception("E2 RPC unexpected error on attempt %d", attempt)
                await asyncio.sleep(self.http_request_delay)

        self.failed_requests += 1
        try:
            await self.close()
        except:
            pass
        return {}

    async def get_controller_list(self):
        logger.debug(f"Fetching controller list")
        payload = {
            "id": 0,
            "method": "E2.GetControllerList",
            "params": [],
        }
        return await self._post_jsonrpc(payload)

    async def get_cell_list(self, controller: str):
        logger.debug(f"Fetching cell list for controller {controller}")
        payload = {
            "id": 0,
            "method": "E2.GetCellList",
            "params": [controller],
        }
        return await self._post_jsonrpc(payload)

    async def get_multi_expanded_status(
        self, controller: str, cellname: str, celltype: str
    ):
        logger.debug(
            f"Fetching expanded status for controller {controller} at cell {cellname} (celltype {celltype})"
        )
        table = CELLTYPE_MAPPINGS_TABLE[CELLTYPE_MAPPINGS_TABLE.celltype == celltype]
        payload = {
            "id": 0,
            "method": "E2.GetMultiExpandedStatus",
            "params": [
                [
                    f"{controller}:{cellname}:{idx}"
                    for idx in table.property_index.tolist()
                ]
            ],
        }
        if payload["params"] == [[]]:
            return {}
        return await self._post_jsonrpc(payload)

    async def get_multi_expanded_status_buffer(self, request_list: list):
        logger.debug(
            f"Fetching exanded status using buffer method of length {len(request_list)}"
        )
        payload = {
            "id": 0,
            "method": "E2.GetMultiExpandedStatus",
            "params": [request_list],
        }
        return await self._post_jsonrpc(payload)

    async def get_alarm_list(self, controller: str):
        logger.debug(f"Fetching alarm list for controller {controller}")
        payload = {
            "id": 0,
            "method": "E2.GetAlarmList",
            "params": [controller],
        }
        return await self._post_jsonrpc(payload)
